# UWB バックグラウンド処理改善実装

## 概要

UWB 通信のバックグラウンド処理を大幅に改善し、アプリがバックグラウンドに移行した後もより長時間安定した通信を維持できるようになりました。

## 実装した改善点

### 1. バックグラウンド処理フレームワークの統合

- **BackgroundTasks**フレームワークを使用
- `BGProcessingTask`による長時間バックグラウンド処理
- 充電時優先実行による電力効率最適化

### 2. アプリ状態管理の強化

```swift
@Published var isBackgroundMode = false // バックグラウンドモードかどうか
@Published var backgroundSessionActive = false // バックグラウンドセッションがアクティブかどうか
```

### 3. インテリジェントなハートビート機能

- 30 秒間隔のバックグラウンドハートビート
- 軽量なメッセージによる接続状態維持
- デバイス接続の自動復帰機能

### 4. 状態保存・復元機能

- アプリ状態変化時の接続情報保存
- フォアグラウンド復帰時の自動復元
- デバイス情報の永続化強化

### 5. 効率的なリソース管理

- 非アクティブセッションの自動停止
- メモリ使用量の最適化
- 不要なデバイス情報のクリーンアップ

## 追加された機能

### バックグラウンドメンテナンス

```swift
private func performBackgroundMaintenance(completion: @escaping (Bool) -> Void) {
    // 1. 期限切れデバイスのクリーンアップ
    // 2. 保存されたデバイス情報の整理
    // 3. ログの整理
}
```

### 動的な通信頻度調整

バックグラウンドでは通信頻度を自動的に下げて電力を節約します。

### 改善された Secure Bubble 処理

```swift
private func handleBackgroundSecureBubbleChange(isInBubble: Bool) {
    // バックグラウンドでの軽量な処理のみ実行
    // 詳細なUI更新はフォアグラウンド復帰時に実行
}
```

## UI の改善

### 1. バックグラウンド状態表示

ContentView と UWBSettingsView で現在の動作モードを視覚的に表示：

- フォアグラウンド: オレンジ色の太陽アイコン
- バックグラウンド: 青色の月アイコン

### 2. バックグラウンドセッション状態

アクティブなバックグラウンドセッションの状態を緑色のチェックマークで表示

## 設定ファイルの更新

### Info.plist

```xml
<key>BGTaskSchedulerPermittedIdentifiers</key>
<array>
    <string>com.pomodororeminder.uwb.maintenance</string>
</array>
```

## 電力効率の最適化

### 1. 充電時優先実行

```swift
request.requiresExternalPower = true // 充電時のみ実行
```

### 2. 軽量なハートビート

必要最小限のデータ送信でデバイス接続を維持

### 3. スマートなセッション管理

アクティブでないセッションを自動的に停止してリソースを節約

## 期待される効果

### 1. 接続安定性の向上

- バックグラウンドでの接続維持時間が大幅に延長
- 自動復帰機能による信頼性向上

### 2. 電力効率の改善

- 充電時優先実行による日常的な電力影響の最小化
- 軽量な通信による消費電力削減

### 3. ユーザビリティの向上

- 状態の透明性向上
- 予期しない動作の削減

## テスト方法

### デバッグコマンド

デバッガーで以下のコマンドを実行してバックグラウンドタスクをシミュレート：

```lldb
e -l objc -- (void)[[BGTaskScheduler sharedScheduler] _simulateLaunchForTaskWithIdentifier:@"com.pomodororeminder.uwb.maintenance"]
```

### 実機テスト

1. デバイス接続後、アプリをバックグラウンドに移行
2. 一定時間経過後にフォアグラウンドに復帰
3. 接続状態と Secure Bubble 状態の確認

## 制限事項

- 完全に永続的なバックグラウンド処理は技術的に不可能
- システムの状況によってはタスクが中断される可能性がある
- 低電力モード時は機能が制限される

## 今後の改善可能性

1. より高度な電力管理アルゴリズム
2. ユーザー使用パターンに基づく最適化
3. より詳細な状態監視とロギング

この実装により、UWB 通信のバックグラウンド処理が大幅に改善され、より実用的なアプリケーションとして機能するようになりました。
