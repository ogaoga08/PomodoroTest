<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="1400" viewBox="0 0 1600 1400">
  <defs>
    <style>
      .box{fill:#fff;stroke:#333;stroke-width:2;rx:8;ry:8}
      .diamond{fill:#fff;stroke:#333;stroke-width:2}
      .title{font:700 22px sans-serif;fill:#111}
      .text{font:15px sans-serif;fill:#111}
      .small{font:13px sans-serif;fill:#555}
      .yes{font:13px sans-serif;fill:#0a7;font-weight:600}
      .no{font:13px sans-serif;fill:#d33;font-weight:600}
      .arrow{stroke:#333;stroke-width:2;fill:none;marker-end:url(#arrow)}
      .arrow-red{stroke:#d33;stroke-width:2;fill:none;marker-end:url(#arrow-red)}
      .arrow-green{stroke:#0a7;stroke-width:2;fill:none;marker-end:url(#arrow-green)}
      .bg{fill:#f7f9fc;stroke:#c8d3e6;stroke-width:2;rx:12;ry:12}
      .note-box{fill:#fffacd;stroke:#e8c800;stroke-width:2;rx:8;ry:8}
    </style>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L10,3 L0,6 Z" fill="#333"/>
    </marker>
    <marker id="arrow-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L10,3 L0,6 Z" fill="#d33"/>
    </marker>
    <marker id="arrow-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L10,3 L0,6 Z" fill="#0a7"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect x="20" y="20" width="1560" height="1360" class="bg"/>

  <!-- Header -->
  <text x="40" y="55" class="title">アプリ制限（Screen Time/Shield）が「有効になる」条件フローチャート</text>
  <text x="40" y="85" class="small">要点: 認証必須 / UWB Secure Bubble内 / 当日タスク条件満足 / 制限対象選択あり</text>

  <!-- Triggers Section -->
  <text x="60" y="130" class="text" font-weight="600">トリガー</text>
  
  <rect x="60" y="150" width="220" height="70" class="box"/>
  <text x="80" y="180" class="text">UWB状態変化</text>
  <text x="80" y="200" class="small">ContentView.onReceive</text>
  <text x="80" y="215" class="small">(isInSecureBubble)</text>

  <rect x="60" y="240" width="220" height="70" class="box"/>
  <text x="80" y="270" class="text">タスク更新</text>
  <text x="80" y="290" class="small">handleTaskUpdate()</text>

  <rect x="60" y="330" width="220" height="70" class="box"/>
  <text x="80" y="360" class="text">タスク完了</text>
  <text x="80" y="380" class="small">handleTaskCompletion()</text>

  <rect x="60" y="420" width="220" height="70" class="box"/>
  <text x="80" y="450" class="text">BG維持チェック</text>
  <text x="80" y="470" class="small">performBackgroundScreen</text>
  <text x="80" y="485" class="small">TimeMaintenance()</text>

  <rect x="60" y="510" width="220" height="70" class="box"/>
  <text x="80" y="540" class="text">直接呼出</text>
  <text x="80" y="560" class="small">enable/disableRestriction()</text>

  <!-- Convergence point -->
  <circle cx="450" cy="300" r="8" fill="#333"/>

  <!-- Arrows from triggers to convergence -->
  <path class="arrow" d="M280,185 L450,185 L450,292"/>
  <path class="arrow" d="M280,275 L450,275 L450,292"/>
  <path class="arrow" d="M280,365 L380,365 L380,300 L442,300"/>
  <path class="arrow" d="M280,455 L380,455 L380,300 L442,300"/>
  <path class="arrow" d="M280,545 L380,545 L380,300 L442,300"/>

  <!-- Condition 1: Authorized -->
  <polygon class="diamond" points="630,300 700,350 630,400 560,350"/>
  <text x="585" y="345" class="text">認証済み?</text>
  <text x="575" y="365" class="small">isAuthorized</text>

  <path class="arrow" d="M458,300 L560,350"/>

  <!-- Condition 2: In Bubble -->
  <polygon class="diamond" points="880,300 950,350 880,400 810,350"/>
  <text x="820" y="345" class="text">UWB Bubble内?</text>
  <text x="815" y="365" class="small">isInSecureBubble</text>

  <path class="arrow-green" d="M700,350 L810,350"/>
  <text x="735" y="340" class="yes">はい</text>

  <!-- Condition 3: Task condition -->
  <polygon class="diamond" points="1130,300 1200,350 1130,400 1060,350"/>
  <text x="1048" y="335" class="text">当日タスク</text>
  <text x="1050" y="352" class="text">条件満足?</text>
  <text x="1042" y="372" class="small">shouldEnable...</text>

  <path class="arrow-green" d="M950,350 L1060,350"/>
  <text x="985" y="340" class="yes">はい</text>

  <!-- Condition 4: Selection -->
  <polygon class="diamond" points="1380,300 1450,350 1380,400 1310,350"/>
  <text x="1315" y="340" class="text">制限対象</text>
  <text x="1315" y="357" class="text">選択あり?</text>
  <text x="1310" y="375" class="small">apps/categories/</text>
  <text x="1310" y="390" class="small">webDomains</text>

  <path class="arrow-green" d="M1200,350 L1310,350"/>
  <text x="1235" y="340" class="yes">はい</text>

  <!-- Enable action -->
  <rect x="1310" y="480" width="200" height="70" class="box" fill="#d4edda" stroke="#28a745"/>
  <text x="1330" y="510" class="text" font-weight="600">制限を有効化</text>
  <text x="1330" y="530" class="small">enableRestriction()</text>

  <path class="arrow-green" d="M1415,400 L1415,480"/>
  <text x="1425" y="445" class="yes">はい</text>

  <!-- Disable action -->
  <rect x="680" y="700" width="200" height="70" class="box" fill="#f8d7da" stroke="#dc3545"/>
  <text x="700" y="730" class="text" font-weight="600">制限を無効化</text>
  <text x="700" y="750" class="small">disableRestriction()</text>

  <!-- No paths to disable -->
  <path class="arrow-red" d="M630,400 L630,700 L680,735"/>
  <text x="565" y="550" class="no">いいえ</text>

  <path class="arrow-red" d="M810,350 L680,350 L680,700 L680,700"/>
  <text x="735" y="340" class="no">いいえ</text>

  <path class="arrow-red" d="M1060,350 L930,350 L930,735 L880,735"/>
  <text x="980" y="340" class="no">いいえ</text>

  <path class="arrow-red" d="M1310,350 L1180,350 L1180,735 L880,735"/>
  <text x="1230" y="340" class="no">いいえ</text>

  <!-- Special case: Task completion -->
  <rect x="60" y="700" width="250" height="90" class="note-box"/>
  <text x="80" y="725" class="text" font-weight="600">タスク完了時の特別処理</text>
  <text x="80" y="745" class="small">• 制限が有効 かつ</text>
  <text x="80" y="762" class="small">• 当日の未完了タスク = 0</text>
  <text x="80" y="779" class="small">→ 即座に無効化</text>

  <path class="arrow" d="M280,365 L350,700 L350,735 L680,735" stroke-dasharray="5,5"/>

  <!-- Special case: Background outside bubble -->
  <rect x="60" y="810" width="250" height="90" class="note-box"/>
  <text x="80" y="835" class="text" font-weight="600">BG維持時の特別処理</text>
  <text x="80" y="855" class="small">• Bubble外 かつ</text>
  <text x="80" y="872" class="small">• 制限が有効</text>
  <text x="80" y="889" class="small">→ 即座に無効化</text>

  <path class="arrow" d="M280,455 L350,810 L350,845 L680,735" stroke-dasharray="5,5"/>

  <!-- Notes Section -->
  <rect x="60" y="940" width="720" height="180" class="box"/>
  <text x="80" y="970" class="text" font-weight="600">当日タスク条件の詳細 (shouldEnableRestrictionBasedOnTasks)</text>
  <text x="80" y="995" class="small">以下の条件を全て満たす必要があります:</text>
  <text x="80" y="1015" class="small">1. 当日のタスクが存在する</text>
  <text x="80" y="1035" class="small">2. 未完了タスクが存在する</text>
  <text x="80" y="1055" class="small">3. 時刻設定タスクがある場合: そのうち1つ以上が現在時刻を過ぎている</text>
  <text x="80" y="1075" class="small">4. 時刻未設定のみの場合: 未完了が1つでもあれば条件満足</text>
  <text x="80" y="1095" class="small">※ 全てのタスクが時刻未到来の場合は条件不満足</text>

  <rect x="60" y="1140" width="720" height="120" class="box"/>
  <text x="80" y="1170" class="text" font-weight="600">制限対象選択について</text>
  <text x="80" y="1195" class="small">以下のいずれか1つ以上が選択されている必要があります:</text>
  <text x="80" y="1215" class="small">• アプリトークン (selectedApplicationTokens)</text>
  <text x="80" y="1235" class="small">• カテゴリトークン (selectedCategoryTokens, except空は除く)</text>
  <text x="80" y="1255" class="small">• Webドメイントークン (selectedWebDomainTokens)</text>

  <!-- Flow summary -->
  <rect x="820" y="940" width="720" height="320" class="box" fill="#e8f4f8" stroke="#0369a1"/>
  <text x="840" y="970" class="text" font-weight="600">フロー要約</text>
  
  <text x="840" y="1000" class="small" font-weight="600">✓ 有効化の条件（全て必要）:</text>
  <text x="860" y="1020" class="small">1. ユーザーが認証済み</text>
  <text x="860" y="1040" class="small">2. UWB Secure Bubble内にいる</text>
  <text x="860" y="1060" class="small">3. 当日タスク条件を満たしている</text>
  <text x="860" y="1080" class="small">4. 制限対象（アプリ/カテゴリ/Webドメイン）が選択されている</text>

  <text x="840" y="1110" class="small" font-weight="600">✗ 無効化される場合（いずれか1つ）:</text>
  <text x="860" y="1130" class="small">• 未認証</text>
  <text x="860" y="1150" class="small">• Bubble外に移動</text>
  <text x="860" y="1170" class="small">• タスク条件不満足（時刻未到来、未完了なし等）</text>
  <text x="860" y="1190" class="small">• 制限対象が未選択</text>
  <text x="860" y="1210" class="small">• 当日の全タスク完了</text>

  <text x="840" y="1240" class="small" font-weight="600">継続的監視:</text>
  <text x="860" y="1260" class="small">• バックグラウンドでも定期的に条件を再評価し、不満足時は無効化</text>

</svg>