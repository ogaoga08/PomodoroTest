# EventKit 専用モード - 実装完了

## 📋 変更内容

### ✅ 位置情報許可の変更

**変更前**: 本アプリで「常に許可」を要求

- アプリ独自のジオフェンス監視（CLLocationManager）
- 画面左上に位置情報ラベルが常時表示される

**変更後**: 本アプリでは「使用中のみ許可」で十分

- EventKit の位置ベースリマインダーを使用
- iOS システムが位置監視を行う
- 画面左上の位置情報ラベルは常時表示されない

---

## 🔧 修正したファイル

### 1. PermissionManager.swift

#### 変更点

- `requestLocationPermission()`: 「常に許可」の要求を削除
  - 「使用中のみ許可」のみを要求
  - EventKit 専用モードであることを明記
- `setupGeofenceWithCurrentLocation()`: 無効化
  - 自動で現在地を取得してジオフェンス設定する処理を削除
  - ユーザーが GeofencingSettingsView で手動設定する方式に変更

#### ログメッセージ

```
📍 EventKit位置ベースリマインダー使用のため、「使用中の許可」のみ要求
ℹ️ EventKit専用モード: アプリ独自のジオフェンス監視は使用しません
ℹ️ 自宅位置情報タスクは手動設定（GeofencingSettingsView）で作成してください
```

### 2. GeofencingSettingsView.swift

#### UI 変更

1. **位置情報許可状態の表示を更新**

   - 「常に許可」ではなく「使用中のみ許可」で十分と表示
   - 「使用中のみ許可」の場合、緑のチェックマークで「EventKit 専用モードでは、これで十分です」と表示

2. **ジオフェンシング状態セクションを「EventKit 自宅タスク状態」に変更**

   - 自宅位置設定状態
   - EventKit タスクの作成状態
   - 監視方式: 「iOS システム（本アプリでは監視しません）」

3. **説明セクションを「EventKit 位置ベースリマインダー」に変更**
   - プライバシー重視モードであることを強調
   - 「使用中のみ許可」で動作することを明記
   - 位置情報ラベルが常時表示されないことを説明

#### ロジック変更

- `saveHomeLocation()`: UWBManager へのジオフェンス設定をスキップ
  - EventKit タスクの作成のみ実行
  - アプリ独自のジオフェンス監視は行わない

#### ログメッセージ

```
ℹ️ EventKit専用モード: アプリ独自のジオフェンス監視はスキップ
📝 EventKitに自宅位置情報タスクを作成します
   - これにより、iOSの標準リマインダーアプリが位置を監視します
   - 本アプリの位置情報許可は「使用中のみ」で十分です
✅ EventKit自宅タスク設定完了
💡 リマインダーアプリで「自宅（UWB自動接続用）」タスクを確認できます
```

---

## 📱 ユーザー体験の変更

### 初回セットアップ

1. 位置情報許可: **「使用中のみ許可」を選択**
2. GeofencingSettingsView で自宅位置を手動設定
3. EventKit に「自宅（UWB 自動接続用）」タスクが自動作成される

### 通常使用

1. ユーザーが自宅に到着
2. **iOS システムが位置を監視**（本アプリではない）
3. リマインダー通知が発火
4. 本アプリが通知を受信して UWB 自動ペアリング開始

### メリット

- ✅ プライバシー重視: 「使用中のみ許可」で動作
- ✅ 位置情報ラベルが常時表示されない
- ✅ バッテリー効率が良い（システムの位置監視を活用）
- ✅ アプリがバックグラウンドでも確実に動作

---

## 🧪 テスト手順

### 1. 位置情報許可の確認

```
1. アプリを初回起動
2. オンボーディングで位置情報許可を要求される
3. 「使用中のみ許可」を選択
4. 「常に許可」は要求されない ✅
```

### 2. 自宅タスク作成の確認

```
1. GeofencingSettingsViewを開く
2. 自宅位置を設定
3. リマインダーアプリを開く
4. 「自宅（UWB自動接続用）」タスクが作成されている ✅
5. タスクの位置情報設定を確認（到着時、半径50m）
```

### 3. 位置情報ラベルの確認

```
1. アプリをバックグラウンドに移動
2. 画面左上を確認
3. 位置情報ラベルが常時表示されない ✅
```

### 4. UWB 自動ペアリングの確認

```
1. 自宅から離れる
2. 自宅に戻る
3. リマインダー通知が表示される
4. UWB自動ペアリングが開始される ✅
5. 進捗通知が表示される
```

---

## ⚠️ 注意事項

### EventKit 専用モードの制約

1. **自宅位置は手動設定が必要**

   - 初回オンボーディングでの自動設定は行わない
   - GeofencingSettingsView で手動設定

2. **リマインダー許可が必須**

   - EventKit にタスクを作成するため、リマインダー許可が必要

3. **位置情報許可は「使用中のみ」で十分**
   - 「常に許可」は不要
   - EventKit が位置監視を行う

### アプリ独自のジオフェンス機能

- UWBManager のジオフェンス関連機能は無効化
- `setHomeLocation()`, `geofencingEnabled`, `isAtHome` などは使用しない
- EventKit 専用モードでは不要

---

## 🔄 フォールバックオプション

もし EventKit アプローチがうまく動作しない場合（位置情報ラベルが常時表示される、バックグラウンドで動作しない等）、ユーザーの指示により**アプリ独自のジオフェンス機能を有効化**できます。

その場合:

1. `PermissionManager.requestLocationPermission()`で「常に許可」を要求
2. `GeofencingSettingsView.saveHomeLocation()`で UWBManager にジオフェンス設定
3. アプリ独自のジオフェンス監視を有効化

---

## ✅ 実装完了

EventKit 専用モードの実装が完了しました。実機でのテストをお試しください！

**期待される結果**:

- 位置情報許可: 「使用中のみ」で動作 ✅
- 位置情報ラベル: 常時表示されない ✅
- UWB 自動ペアリング: 正常に動作 ✅
- バッテリー効率: 良好 ✅
